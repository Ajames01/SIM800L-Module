‚òÅ Project: DHT11 to ThingSpeak via GPRS (No WiFi)
This guide provides the complete code and setup instructions for logging environmental data (Temperature and Humidity) from a DHT11 sensor to the ThingSpeak IoT platform using the SIM800L GSM module's GPRS connection.
‚öô Prerequisites
 * Hardware Setup: Ensure your SIM800L is connected to your Arduino/ESP32, paying close attention to power supply and logic levels (refer to the previous connection guides).
 * Software Libraries: Install the following in your Arduino IDE:
   * DHT.h (from Adafruit or a similar source).
   * SoftwareSerial.h (comes standard with Arduino IDE, needed for Uno).
 * ThingSpeak Setup:
   * Create a ThingSpeak channel with two fields: Field 1 for Temperature and Field 2 for Humidity.
   * Obtain your Channel's Write API Key.
üõ† Configuration Constants
You must update the following constants in the code below with your specific details (pins, GPRS, and ThingSpeak credentials).
| Constant | Description | Example Value |
|---|---|---|
| APN | Your mobile carrier's Access Point Name. | "internet" or "data.globe.com.ph" |
| APN_USER | APN Username (often blank, use ""). | "" |
| THINGSPEAK_API_KEY | Your ThingSpeak Channel Write API Key. | "YOUR_KEY_HERE" |
| RX_PIN / TX_PIN | Serial communication pins. | 2/3 (Arduino Uno) or 16/17 (ESP32) |
üíª The Arduino / ESP32 Code (sim800l_dht_thingspeak.ino)
Copy the entire block below and save it as your sketch file. Remember to adjust the pin and credential constants at the top.
// ---------------------- Libraries ----------------------
#include <HardwareSerial.h>
#include <DHT.h>

// ---------------------- Pin Definitions ----------------------
#define DHTPIN 13         // DHT11 sensor data pin
#define DHTTYPE DHT11     // DHT sensor type

// ---------------------- Objects ----------------------
DHT dht(DHTPIN, DHTTYPE);
HardwareSerial sim800(2);  // Use Serial2 (RX=16, TX=17)

// ---------------------- Settings ----------------------
const char* apiKey = "SDPDJHEEWACBUB3D";  // Your ThingSpeak API Key
const char* apn = "web.gprs.mtnnigeria.net";  // Your network APN

// ---------------------- State Variables ----------------------
enum State {
  CHECK_AT,
  CHECK_SIM,
  WAIT_NETWORK,
  CHECK_GPRS,
  SETUP_BEARER_PROFILE,
  OPEN_BEARER,
  QUERY_BEARER,
  INIT_HTTP,
  SET_HTTP_PARAMS,
  READ_SENSOR,
  SET_URL,
  HTTP_GET,
  READ_RESPONSE,
  TERMINATE_HTTP,
  WAIT_NEXT,
  ERROR_STATE
};

State currentState = CHECK_AT;
unsigned long stateStartTime = 0;
int networkAttempts = 0;
float temperature = 0;
float humidity = 0;

void setup() {
  Serial.begin(115200);
  Serial.println("\n\n=== ESP32 + SIM800L + ThingSpeak (HTTP Method) ===\n");
  
  sim800.begin(9600, SERIAL_8N1, 16, 17); // RX=16, TX=17
  dht.begin();
  
  Serial.println("Waiting 3 seconds for module to be ready...");
  delay(3000);
  
  stateStartTime = millis();
}

void loop() {
  switch (currentState) {
    case CHECK_AT:
      handleCheckAT();
      break;
      
    case CHECK_SIM:
      handleCheckSIM();
      break;
      
    case WAIT_NETWORK:
      handleWaitNetwork();
      break;
      
    case CHECK_GPRS:
      handleCheckGPRS();
      break;
      
    case SETUP_BEARER_PROFILE:
      handleSetupBearer();
      break;
      
    case OPEN_BEARER:
      handleOpenBearer();
      break;
      
    case QUERY_BEARER:
      handleQueryBearer();
      break;
      
    case INIT_HTTP:
      handleInitHTTP();
      break;
      
    case SET_HTTP_PARAMS:
      handleSetHTTPParams();
      break;
      
    case READ_SENSOR:
      handleReadSensor();
      break;
      
    case SET_URL:
      handleSetURL();
      break;
      
    case HTTP_GET:
      handleHTTPGet();
      break;
      
    case READ_RESPONSE:
      handleReadResponse();
      break;
      
    case TERMINATE_HTTP:
      handleTerminateHTTP();
      break;
      
    case WAIT_NEXT:
      handleWaitNext();
      break;
      
    case ERROR_STATE:
      handleError();
      break;
  }
}

// ---------------------- Helper Functions ----------------------

void changeState(State newState) {
  currentState = newState;
  stateStartTime = millis();
  clearBuffer();
}

void clearBuffer() {
  while (sim800.available()) {
    sim800.read();
  }
}

String readResponse(unsigned long timeout) {
  String response = "";
  unsigned long start = millis();
  
  while (millis() - start < timeout) {
    while (sim800.available()) {
      char c = sim800.read();
      response += c;
      Serial.write(c);
    }
    delay(10);
  }
  
  return response;
}

bool sendCommandAndWait(const char* cmd, const char* expected, unsigned long timeout) {
  Serial.print("Sending: ");
  Serial.println(cmd);
  
  clearBuffer();
  sim800.println(cmd);
  
  String response = readResponse(timeout);
  bool success = response.indexOf(expected) >= 0;
  
  if (success) {
    Serial.println("‚úì SUCCESS");
  } else {
    Serial.print("‚úó FAILED - Expected: ");
    Serial.println(expected);
  }
  
  return success;
}

// ---------------------- State Handlers ----------------------

void handleCheckAT() {
  Serial.println("[STEP 1] Testing AT communication...");
  
  if (sendCommandAndWait("AT", "OK", 2000)) {
    Serial.println();
    changeState(CHECK_SIM);
  } else {
    Serial.println("Retrying in 2 seconds...\n");
    delay(2000);
  }
}

void handleCheckSIM() {
  Serial.println("[STEP 2] Checking SIM card status...");
  
  if (sendCommandAndWait("AT+CPIN?", "READY", 3000)) {
    Serial.println();
    networkAttempts = 0;
    changeState(WAIT_NETWORK);
  } else {
    Serial.println("‚úó SIM card not detected or locked!\n");
    changeState(ERROR_STATE);
  }
}

void handleWaitNetwork() {
  Serial.print("[STEP 3] Checking network registration (Attempt ");
  Serial.print(networkAttempts + 1);
  Serial.println("/20)...");
  
  clearBuffer();
  sim800.println("AT+CREG?");
  String response = readResponse(2000);
  
  if (response.indexOf("+CREG: 0,1") >= 0 || response.indexOf("+CREG: 0,5") >= 0) {
    Serial.println("‚úì Registered on network!");
    
    // Check signal quality
    Serial.println("\nChecking signal quality...");
    clearBuffer();
    sim800.println("AT+CSQ");
    response = readResponse(2000);
    Serial.println();
    
    changeState(CHECK_GPRS);
  } else {
    networkAttempts++;
    if (networkAttempts >= 20) {
      Serial.println("‚úó Network registration timeout!\n");
      changeState(ERROR_STATE);
    } else {
      Serial.println("Waiting for network...\n");
      delay(2000);
    }
  }
}

void handleCheckGPRS() {
  Serial.println("[STEP 4] Checking GPRS attachment...");
  
  clearBuffer();
  sim800.println("AT+CGATT?");
  String response = readResponse(3000);
  
  if (response.indexOf("+CGATT: 1") >= 0) {
    Serial.println("‚úì GPRS already attached\n");
    changeState(SETUP_BEARER_PROFILE);
  } else {
    Serial.println("Attaching to GPRS...");
    if (sendCommandAndWait("AT+CGATT=1", "OK", 5000)) {
      Serial.println();
      delay(2000);
      changeState(SETUP_BEARER_PROFILE);
    } else {
      Serial.println("‚úó GPRS attachment failed!\n");
      changeState(ERROR_STATE);
    }
  }
}

void handleSetupBearer() {
  Serial.println("[STEP 5] Setting up GPRS bearer profile...");
  
  // Set connection type to GPRS
  Serial.println("Setting connection type...");
  if (!sendCommandAndWait("AT+SAPBR=3,1,\"CONTYPE\",\"GPRS\"", "OK", 2000)) {
    changeState(ERROR_STATE);
    return;
  }
  
  delay(500);
  
  // Set APN
  Serial.print("Setting APN: ");
  Serial.println(apn);
  
  String cmd = "AT+SAPBR=3,1,\"APN\",\"";
  cmd += apn;
  cmd += "\"";
  
  if (!sendCommandAndWait(cmd.c_str(), "OK", 2000)) {
    changeState(ERROR_STATE);
    return;
  }
  
  Serial.println("‚úì Bearer profile configured\n");
  delay(500);
  changeState(OPEN_BEARER);
}

void handleOpenBearer() {
  Serial.println("[STEP 6] Opening GPRS bearer...");
  Serial.println("This may take 5-10 seconds...");
  
  clearBuffer();
  sim800.println("AT+SAPBR=1,1");
  String response = readResponse(15000);
  
  if (response.indexOf("OK") >= 0 || response.indexOf("ALREADY") >= 0) {
    Serial.println("‚úì Bearer opened successfully\n");
    delay(2000);
    changeState(QUERY_BEARER);
  } else {
    Serial.println("‚úó Failed to open bearer!\n");
    changeState(ERROR_STATE);
  }
}

void handleQueryBearer() {
  Serial.println("[STEP 7] Querying bearer status...");
  
  clearBuffer();
  sim800.println("AT+SAPBR=2,1");
  String response = readResponse(3000);
  
  if (response.indexOf("+SAPBR: 1,1") >= 0) {
    Serial.println("‚úì Bearer active with IP address\n");
    changeState(INIT_HTTP);
  } else {
    Serial.println("‚úó Bearer not active!\n");
    changeState(ERROR_STATE);
  }
}

void handleInitHTTP() {
  Serial.println("[STEP 8] Initializing HTTP service...");
  
  // Try to terminate first if already initialized
  sim800.println("AT+HTTPTERM");
  delay(1000);
  clearBuffer();
  
  if (sendCommandAndWait("AT+HTTPINIT", "OK", 3000)) {
    Serial.println();
    changeState(SET_HTTP_PARAMS);
  } else {
    Serial.println("‚úó HTTP initialization failed!\n");
    changeState(ERROR_STATE);
  }
}

void handleSetHTTPParams() {
  Serial.println("[STEP 9] Setting HTTP parameters...");
  
  // Set HTTP parameters to use bearer profile 1
  if (!sendCommandAndWait("AT+HTTPPARA=\"CID\",1", "OK", 2000)) {
    changeState(ERROR_STATE);
    return;
  }
  
  Serial.println("‚úì HTTP parameters set\n");
  Serial.println("=== INITIALIZATION COMPLETE ===\n");
  delay(1000);
  changeState(READ_SENSOR);
}

void handleReadSensor() {
  Serial.println("[STEP 10] Reading DHT11 sensor...");
  
  humidity = dht.readHumidity();
  temperature = dht.readTemperature();
  
  if (isnan(humidity) || isnan(temperature)) {
    Serial.println("‚úó Failed to read sensor!");
    Serial.println("Retrying in 2 seconds...\n");
    delay(2000);
    return;
  }
  
  Serial.print("Temperature: ");
  Serial.print(temperature);
  Serial.println(" ¬∞C");
  Serial.print("Humidity: ");
  Serial.print(humidity);
  Serial.println(" %");
  Serial.println("‚úì Sensor data read successfully\n");
  
  changeState(SET_URL);
}

void handleSetURL() {
  Serial.println("[STEP 11] Setting ThingSpeak URL...");
  
  String url = "http://api.thingspeak.com/update?api_key=";
  url += apiKey;
  url += "&field1=";
  url += String(temperature, 2);
  url += "&field2=";
  url += String(humidity, 2);
  
  Serial.println("URL:");
  Serial.println(url);
  
  String cmd = "AT+HTTPPARA=\"URL\",\"";
  cmd += url;
  cmd += "\"";
  
  clearBuffer();
  sim800.println(cmd);
  String response = readResponse(3000);
  
  if (response.indexOf("OK") >= 0) {
    Serial.println("‚úì URL set successfully\n");
    changeState(HTTP_GET);
  } else {
    Serial.println("‚úó Failed to set URL!\n");
    changeState(ERROR_STATE);
  }
}

void handleHTTPGet() {
  Serial.println("[STEP 12] Executing HTTP GET request...");
  Serial.println("Waiting for response (this may take 10-20 seconds)...");
  
  clearBuffer();
  sim800.println("AT+HTTPACTION=0");  // 0 = GET method
  
  // First wait for "OK" acknowledgment
  String response = "";
  unsigned long start = millis();
  bool gotOK = false;
  
  while (millis() - start < 3000) {
    while (sim800.available()) {
      char c = sim800.read();
      response += c;
      Serial.write(c);
    }
    if (response.indexOf("OK") >= 0) {
      gotOK = true;
      break;
    }
    delay(10);
  }
  
  if (!gotOK) {
    Serial.println("\n‚úó GET request failed - no OK!\n");
    changeState(ERROR_STATE);
    return;
  }
  
  Serial.println("\n‚úì Request sent, waiting for +HTTPACTION response...");
  
  // Now wait for +HTTPACTION: response (can take 10-20 seconds)
  response = "";
  start = millis();
  bool gotAction = false;
  
  while (millis() - start < 20000) {  // Wait up to 20 seconds
    while (sim800.available()) {
      char c = sim800.read();
      response += c;
      Serial.write(c);
    }
    
    if (response.indexOf("+HTTPACTION:") >= 0) {
      gotAction = true;
      break;
    }
    
    // Show progress dots every 2 seconds
    if ((millis() - start) % 2000 < 50) {
      Serial.print(".");
    }
    
    delay(100);
  }
  
  Serial.println();
  
  if (gotAction) {
    Serial.println("‚úì Action completed!");
    
    // Check status code
    if (response.indexOf("+HTTPACTION: 0,200") >= 0 || 
        response.indexOf("+HTTPACTION:0,200") >= 0) {
      Serial.println("‚úì‚úì‚úì HTTP 200 OK - DATA SENT SUCCESSFULLY! ‚úì‚úì‚úì\n");
    } else if (response.indexOf(",404") >= 0) {
      Serial.println("‚úó HTTP 404 - Not Found\n");
    } else if (response.indexOf(",400") >= 0) {
      Serial.println("‚úó HTTP 400 - Bad Request (check API key)\n");
    } else if (response.indexOf(",601") >= 0) {
      Serial.println("‚úó HTTP 601 - Network Error\n");
    } else if (response.indexOf(",602") >= 0) {
      Serial.println("‚úó HTTP 602 - No Memory\n");
    } else if (response.indexOf(",603") >= 0) {
      Serial.println("‚úó HTTP 603 - DNS Error\n");
    } else if (response.indexOf(",604") >= 0) {
      Serial.println("‚úó HTTP 604 - Stack Busy\n");
    } else {
      Serial.println("‚ö† Unknown HTTP status in response\n");
    }
    
    changeState(READ_RESPONSE);
  } else {
    Serial.println("‚úó Timeout waiting for +HTTPACTION response!\n");
    Serial.println("This could mean:");
    Serial.println("- Weak signal");
    Serial.println("- DNS resolution failed");
    Serial.println("- Network congestion");
    changeState(TERMINATE_HTTP);
  }
}

void handleReadResponse() {
  Serial.println("[STEP 13] Reading server response...");
  
  clearBuffer();
  sim800.println("AT+HTTPREAD");
  String response = readResponse(5000);
  
  Serial.println("‚úì Response read\n");
  changeState(TERMINATE_HTTP);
}

void handleTerminateHTTP() {
  Serial.println("[STEP 14] Terminating HTTP service...");
  
  sendCommandAndWait("AT+HTTPTERM", "OK", 2000);
  Serial.println();
  
  changeState(WAIT_NEXT);
}

void handleWaitNext() {
  Serial.println("=== Cycle complete! ===");
  Serial.println("Waiting 20 seconds before next update...\n");
  
  delay(20000);
  changeState(READ_SENSOR);
}

void handleError() {
  Serial.println("\n!!! ERROR STATE !!!");
  Serial.println("Closing HTTP and bearer...");
  
  sim800.println("AT+HTTPTERM");
  delay(1000);
  sim800.println("AT+SAPBR=0,1");
  delay(2000);
  
  Serial.println("Restarting initialization in 10 seconds...\n");
  delay(10000);
  
  networkAttempts = 0;
  changeState(CHECK_AT);
}
